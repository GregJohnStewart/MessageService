<!DOCTYPE html>
<html lang="en_us">
    <head>
        <meta charset="UTF-8">
        <title>Landing Page - Editor</title>
        <link rel="stylesheet" href="/res/lib/bootstrap/5.3.3/css/bootstrap.min.css">
        <link rel="stylesheet" href="/res/lib/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css">
        <link rel="stylesheet" href="/res/css/main.css">
        <style>
        </style>
    </head>
    <body class="min-vh-100 vstack">
    {#let priorityMessages = cdi:PriorityMessageRepository.getMessagesToDisplay()}
        <div class="container-fluid min-vh-100 d-flex flex-column">
            <main id="content">
                <div class="row">
                    <div class="col-6 justify-content-start">
                        <h1 class="text-light align-middle">Landing Page - Editor</h1>
                    </div>
                    <div class="col-6 text-end">
                        <a href="/" class="btn btn-primary btn-sm">Close</a>
                    </div>
                </div>

                <div id="message-table" class="table-container">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h2 class="text-light  mb-0">Messages</h2>
                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editModal" onclick="showDetails('create', '')" title="Create New Message">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                    <table class="table table-striped table-hover opacity-75">
                        <thead>
                        <tr>
                            <th>Subject</th>
                            <th style="width:10%">Priority</th>
                            <th style="width:10%">Start Date</th>
                            <th style="width:10%">End Date</th>
                        </tr>
                        </thead>
                        <tbody>
                        {#if priorityMessages.isEmpty}
                            <tr>
                                <td colspan="4" class="text-center">
                                    No Messages to edit!
                                </td>
                            </tr>
                        {#else}
                            {#for message in priorityMessages}
                                <tr id="message-row-{message.id}" data-bs-toggle="modal" data-bs-target="#editModal" data-message-data="{message.toJSON()}" onclick="showDetails('update', '{message.id}')">
                                    <td>
                                        {message.subject}
                                    </td>
                                    <td>
                                        {message.priority}
                                    </td>
                                    <td>
                                        {message.getFormattedStartDate()}
                                    </td>
                                    <td>
                                        {message.getFormattedEndDate()}
                                    </td>
                                </tr>
                            {/for}
                        {/if}
                        </tbody>
                    </table>
                </div>
            </main>
        </div>

        <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTitle">Message Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="message-form" novalidate>
                            <div class="mb-3 row">
                                <label for="subject" class="col-sm-3 col-form-label">Subject</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="subject" name="subject" required>
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <label for="message" class="col-sm-3 col-form-label">Message</label>
                                <div class="col-sm-9">
                                    <textarea class="form-control" id="message" name="message" rows="5" required></textarea>
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <label for="priority" class="col-sm-3 col-form-label">Priority</label>
                                <div class="col-sm-9">
                                    <select class="form-control" id="priority" name="priority" required>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <label for="startDate" class="col-sm-3 col-form-label">Start Date</label>
                                <div class="col-sm-9">
                                    <input type="date" class="form-control" id="startDate" name="startDate" required>
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <label for="endDate" class="col-sm-3 col-form-label">End Date</label>
                                <div class="col-sm-9">
                                    <input type="date" class="form-control" id="endDate" name="endDate" required>
                                </div>
                            </div>
                            <!-- Readonly fields do not require validation -->
                            <div class="mb-3 row">
                                <label for="lastUpdatedBy" class="col-sm-3 col-form-label">Last Updated By</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="lastUpdatedBy" name="lastUpdatedBy" readonly>
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <label for="lastUpdated" class="col-sm-3 col-form-label">Last Updated</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="lastUpdated" name="lastUpdated" readonly>
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <label for="createdBy" class="col-sm-3 col-form-label">Created By</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="createdBy" name="createdBy" readonly>
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <label for="createdAt" class="col-sm-3 col-form-label">Created At</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="createdAt" name="createdAt" readonly>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" onclick="if($('#message-form').valid()) saveMessage()">Save</button>
                        <button type="button" class="btn btn-primary" onclick="deleteMessage()">Delete</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <script src="/res/lib/jquery/3.7.1/jquery.min.js"></script>
        <script src="/res/lib/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
        <script src="/res/lib/jquery-validate/1.19.5/jquery.validate.min.js"></script>
        <script>
            var currentMessage;
            var currentDialogType;

            function stripQuotes(str) {
                if (str.startsWith('"') || str.startsWith("'")) {
                    str = str.slice(1);
                }
                if (str.endsWith('"') || str.endsWith("'")) {
                    str = str.slice(0, -1);
                }
                return str;
            }

            function showDetails(dialogType, messageId) {
                let jsonmessage;

                currentDialogType = dialogType;
                if(dialogType == 'create') {
                    console.log("dialogType: " + dialogType);

                    jsonmessage = '{"id":"","subject":"","priority":"1","startDate":"","endDate":"","createdBy":"","createdAt":"","lastUpdatedBy":"","lastUpdated":"","content":""}';
                    console.log("Create JSON Message: " + jsonmessage);
                } else {
                    console.log("dialogType: " + dialogType);

                    jsonmessage = document.getElementById('message-row-' + messageId).dataset.messageData;
                    console.log("Update JSON Message: " + jsonmessage);
                }

                currentMessage = JSON.parse(jsonmessage);

                document.getElementById('subject').value = currentMessage.subject;
                document.getElementById('message').value = currentMessage.content;
                document.getElementById('priority').value = currentMessage.priority;
                document.getElementById('startDate').value = currentMessage.startDate;
                document.getElementById('endDate').value = currentMessage.endDate;
                document.getElementById('lastUpdatedBy').value = currentMessage.lastUpdatedBy;
                document.getElementById('lastUpdated').value = currentMessage.lastUpdated;
                document.getElementById('createdBy').value = currentMessage.createdBy;
                document.getElementById('createdAt').value = currentMessage.createdAt;
            }

            function saveMessage() {
                currentMessage.subject = document.getElementById('subject').value;
                currentMessage.content = document.getElementById('message').value;
                currentMessage.priority = document.getElementById('priority').value;
                currentMessage.startDate = document.getElementById('startDate').value;
                currentMessage.endDate = document.getElementById('endDate').value;
                currentMessage.lastUpdatedBy = document.getElementById('lastUpdatedBy').value;
                currentMessage.lastUpdated = document.getElementById('lastUpdated').value;
                currentMessage.createdBy = document.getElementById('createdBy').value;
                currentMessage.createdAt = document.getElementById('createdAt').value;

                if(currentDialogType == 'create') {
                    insertMessage(currentMessage);
                } else {
                    updateMessage(currentMessage);
                }
            }

            function refreshTable() {
                $.ajax({
                    url: '/api/landpage/messages-table', // REST endpoint returns rendered HTML fragment
                    type: 'GET',
                    dataType: 'html',
                    success: function(htmlFragment) {
                        // Replace the table body content with the new HTML fragment
                        $('#message-table table tbody').html(htmlFragment);
                    },
                    error: function(xhr, status, error) {
                        console.error('Error refreshing table:', error);
                    }
                });
            }

            function insertMessage(message) {
                $.ajax({
                    url: '/api/landpage/message',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(message),
                    success: function(response) {
                        console.log('Message saved successfully:', response);

                        refreshTable(); // Refresh the table with updated data

                        // Hide the modal after a successful save
                        let modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
                        modal.hide();
                    },
                    error: function(xhr, status, error) {
                        console.error('Error saving message:', error);
                        alert('Error saving message: ' + error);
                    }
                });
            }

            function updateMessage(message) {
                // Send the updated message to the REST API
                $.ajax({
                    url: '/api/landpage/message/' + message.id,
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(message),
                    success: function(response) {
                        console.log('Message udpated successfully:', response);

                        refreshTable(); // Refresh the table with updated data

                        // Hide the modal after a successful save
                        let modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
                        modal.hide();
                    },
                    error: function(xhr, status, error) {
                        console.error('Error updating message:', error);
                        alert('Error updating message: ' + error);
                    }
                });
            }

            function deleteMessage() {
                if(currentDialogType == 'create') {
                    // Ignore the delete button call.
                    return;
                }

                if (confirm('Are you sure you want to delete the message:\n' + currentMessage.subject)) {
                    // Send the delete message id to the REST API
                    $.ajax({
                        url: '/api/landpage/message/' + currentMessage.id,
                        type: 'DELETE',
                        success: function(response) {
                            console.log('Message deleted successfully:', response);

                            refreshTable(); // Refresh the table with updated data

                            // Hide the modal after a successful save
                            let modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
                            modal.hide();
                        },
                        error: function(xhr, status, error) {
                            console.error('Error deleting message:', error);
                            alert('Error deleting message: ' + error);
                        }
                    });
                }
            }

            // Initialize jQuery Validate on the form
            $(document).ready(function() {
                $("#message-form").validate({
                    rules: {
                    subject: {
                        required: true,
                        maxlength: 255
                    },
                    message: {
                        required: true,
                        maxlength: 1024
                    },
                    priority: "required",
                    startDate: "required",
                    endDate: "required"
                    },
                    messages: {
                    subject: {
                        required: "Please enter a subject",
                        maxlength: "The subject must be no longer than 255 characters"
                    },
                    message: {
                        required: "Please enter a message",
                        maxlength: "The message must be no longer than 1024 characters"
                    },
                    priority: "Please select a priority",
                    startDate: "Please select a start date",
                    endDate: "Please select an end date"
                    },
                    errorClass: "is-invalid",
                    validClass: "is-valid",
                    errorElement: "div",
                    errorPlacement: function(error, element) {
                    error.addClass("invalid-feedback");
                    error.insertAfter(element);
                    },
                    highlight: function(element, errorClass, validClass) {
                    $(element).addClass(errorClass).removeClass(validClass);
                    },
                    unhighlight: function(element, errorClass, validClass) {
                    $(element).removeClass(errorClass).addClass(validClass);
                    }
                });
            });
        </script>

    </body>
</html>