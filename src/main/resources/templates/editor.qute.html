<!DOCTYPE html>
<html lang="en_us">
<head>
	<meta charset="UTF-8">
	<title>Landing Page - Editor</title>
	<link rel="stylesheet" href="/res/lib/bootstrap/5.3.3/css/bootstrap.min.css">
	<link rel="stylesheet" href="/res/lib/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css">
	<link rel="stylesheet" href="/res/css/main.css">
	<style>
        .modal-dialog {
            max-height: 80vh;
        }
        .modal-body {
            max-height: 75vh;
            overflow-y: auto;
        }
	</style>
</head>
<body class="min-vh-100 vstack">
{#let priorityMessages = cdi:PriorityMessageRepository.getMessagesToDisplay()}
	<div class="container-fluid min-vh-100 d-flex flex-column">
		<main id="content">
            <div class="row">
                <div class="col-6 justify-content-start">
                    <h1 class="text-light align-middle">Landing Page - Editor</h1>
                </div>
                <div class="col-6 text-end">
                    <a href="/" class="btn btn-primary btn-sm">Close</a>
                </div>
            </div>

            <div id="message-table" class="table-container">
				<table class="table table-striped table-hover opacity-75">
					<thead>
					<tr>
						<th>Subject</th>
						<th style="width:10%">Priority</th>
						<th style="width:10%">Start Date</th>
						<th style="width:10%">End Date</th>
					</tr>
					</thead>
					<tbody>
					{#if priorityMessages.isEmpty}
						<tr>
							<td colspan="4" class="text-center">
								No Messages to edit!
							</td>
						</tr>
					{#else}
						{#for message in priorityMessages}
							<tr id="message-row-{message.id}" data-bs-toggle="modal" data-bs-target="#editModal" onclick="showDetails('{message.toJSON()}')">
								<td>
									{message.subject}
								</td>
								<td>
									{message.priority}
								</td>
								<td>
									{message.getFormattedStartDate()}
								</td>
								<td>
									{message.getFormattedEndDate()}
								</td>
							</tr>
						{/for}
					{/if}
					</tbody>
				</table>
			</div>
		</main>
	</div>

	<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Message Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="mb-3 row">
                            <label for="subject" class="col-sm-3 col-form-label">Subject</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="subject" required>
                            </div>
                        </div>
                        <div class="mb-3 row">
                            <label for="message" class="col-sm-3 col-form-label">Message</label>
                            <div class="col-sm-9">
                                <textarea class="form-control" id="message" rows="5" required></textarea>
                            </div>
                        </div>
                        <div class="mb-3 row">
                            <label for="priority" class="col-sm-3 col-form-label">Priority</label>
                            <div class="col-sm-9">
                                <select class="form-control" id="priority" required>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3 row">
                            <label for="startDate" class="col-sm-3 col-form-label">Start Date</label>
                            <div class="col-sm-9">
                                <input type="date" class="form-control" id="startDate" required>
                            </div>
                        </div>
                        <div class="mb-3 row">
                            <label for="endDate" class="col-sm-3 col-form-label">End Date</label>
                            <div class="col-sm-9">
                                <input type="date" class="form-control" id="endDate" required>
                            </div>
                        </div>
                        <div class="mb-3 row">
                            <label for="lastUpdatedBy" class="col-sm-3 col-form-label">Last Updated By</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="lastUpdatedBy" readonly>
                            </div>
                        </div>
                        <div class="mb-3 row">
                            <label for="lastUpdated" class="col-sm-3 col-form-label">Last Updated</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="lastUpdated" readonly>
                            </div>
                        </div>
                        <div class="mb-3 row">
                            <label for="createdBy" class="col-sm-3 col-form-label">Created By</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="createdBy" readonly>
                            </div>
                        </div>
                        <div class="mb-3 row">
                            <label for="createdAt" class="col-sm-3 col-form-label">Created At</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="createdAt" readonly>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="saveMessage()">Save</button>
                    <button type="button" class="btn btn-primary" onclick="deleteMessage()">Delete</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

<!--	
	{#for message in priorityMessages}
		<div class="modal fade" id="message-modal-{message.id}" tabindex="-1" aria-labelledby="message-modal-{message.id}-label" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h1 class="modal-title fs-5" id="message-modal-{message.id}-label">{message.subject}</h1>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						{message.content}
						<hr/>
						<p class="h5">Start Date: {message.getFormattedStartDate()}</p>
						<p class="h5">End Date: {message.getFormattedEndDate()}</p>
						<p class="h5">Priority: {message.priority}</p>
						<p class="h5">Last Updated By: {message.lastUpdatedBy}</p>
						<p class="h5">Last Updated: {message.getFormattedLastUpdated()}</p>
						<p class="h5">Created By: {message.createdBy}</p>
						<p class="h5">Created At: {message.getFormattedCreatedAt()}</p>
					</div>
				</div>
			</div>
		</div>
	{/for}

{/let}
	-->
<script src="/res/lib/jquery/3.7.1/jquery.min.js"></script>
<script src="/res/lib/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
<script>
    var currentJSONMessage;

	function stripQuotes(str) {
		if (str.startsWith('"') || str.startsWith("'")) {
			str = str.slice(1);
		}
		if (str.endsWith('"') || str.endsWith("'")) {
			str = str.slice(0, -1);
		}
		return str;
	}

    function showDetails(jsonmessage) {
        currentJSONMessage = jsonmessage;

		message = JSON.parse(stripQuotes(jsonmessage));

		document.getElementById('subject').value = message.subject;
		document.getElementById('message').value = message.content;
		document.getElementById('priority').value = message.priority;
		document.getElementById('startDate').value = message.startDate;
		document.getElementById('endDate').value = message.endDate;
		document.getElementById('lastUpdatedBy').value = message.lastUpdatedBy;
		document.getElementById('lastUpdated').value = message.lastUpdated;
		document.getElementById('createdBy').value = message.createdBy;
		document.getElementById('createdAt').value = message.createdAt;
    }

    function saveMessage() {
		message = JSON.parse(stripQuotes(currentJSONMessage));

        message.subject = document.getElementById('subject').value;
		message.content = document.getElementById('message').value;
        message.priority = document.getElementById('priority').value;
        message.startDate = document.getElementById('startDate').value;
        message.endDate = document.getElementById('endDate').value;
        message.lastUpdatedBy = document.getElementById('lastUpdatedBy').value;
        message.lastUpdated = document.getElementById('lastUpdated').value;
        message.createdBy = document.getElementById('createdBy').value;
        message.createdAt = document.getElementById('createdAt').value;

        alert("Saving Pressed: " + JSON.stringify(message));

        let modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
        modal.hide();
    }

    function deleteMessage() {
        if (confirm('Are you sure you want to delete this message?')) {
            
            let modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
            modal.hide();
        }
    }
</script>

</body>
</html>

<!--
<!DOCTYPE html>
<html lang="en_us">
<head>
	<meta charset="UTF-8">
	<title>Landing Page - Editor</title>
	<link rel="stylesheet" href="/res/lib/bootstrap/5.3.3/css/bootstrap.min.css">
	<link rel="stylesheet" href="/res/lib/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css">
	<link rel="stylesheet" href="/res/lib/jsgrid/1.5.3/jsgrid.min.css">
	<link rel="stylesheet" href="/res/lib/jsgrid/1.5.3/jsgrid-theme.min.css">
	<link rel="stylesheet" href="/res/lib/jquery-ui/1.14.1/jquery-ui.theme.min.css">
	<link rel="stylesheet" href="/res/css/main.css">
	<style>
    .ui-widget *, .ui-widget input, .ui-widget select, .ui-widget button  {
        font-family: 'Helvetica Neue Light', 'Open Sans', Helvetica;
        font-size: 14px;
        font-weight: 300 !important;
    }

    .details-form-field input,
    .details-form-field select {
        width: 250px;
        float: right;
    }

    .details-form-field {
        margin: 30px 0;
    }

    .details-form-field:first-child {
        margin-top: 10px;
    }

    .details-form-field:last-child {
        margin-bottom: 10px;
    }

    .details-form-field button {
        display: block;
        width: 100px;
        margin: 0 auto;
    }

    input.error, select.error {
        border: 1px solid #ff9999;
        background: #ffeeee;
    }

    label.error {
        float: right;
        margin-left: 100px;
        font-size: .8em;
        color: #ff6666;
    }

    .hasDatepicker {
        width: 100px;
        text-align: center;
    }

    .ui-datepicker * {
        font-family: 'Helvetica Neue Light', 'Open Sans', Helvetica;
        font-size: 14px;
        font-weight: 300 !important;
    }
	</style>
</head>
<body class="min-vh-100 vstack">
<div class="container-fluid min-vh-100 d-flex flex-column">
	<main id="content">
		<div class="row">
			<div class="col-6 justify-content-start">
				<h1 class="text-light align-middle">Landing Page - Editor</h1>
			</div>
			<div class="col-6 text-end">
				<a href="/" class="btn btn-primary btn-sm">Close</a>
			</div>
		</div>
		
		<div class="row">
			<div class="col">
				<div id="messagesGrid"></div>
			</div>
		</div>
	</main>
</div>

<div id="detailsDialog">
    <form id="detailsForm">
        <div class="details-form-field">
            <label for="subject">Subject:</label>
            <input id="subject" name="subject" type="text" />
        </div>
        <div class="details-form-field">
            <label for="priority">Priority:</label>
            <select id="priority" name="priority">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
            </select>
        </div>
        <div class="details-form-field">
            <label for="startDate">Start Date:</label>
            <input id="startDate" name="startDate" type="date" />
        </div>
        <div class="details-form-field">
            <label for="endDate">End Date:</label>
            <input id="endDate" name="endDate" type="date" />
        </div>
        <div class="details-form-field">
            <label for="msgcontent">Content:</label>
            <input id="msgcontent" name="msgcontent" type="text" />
        </div>
        <div class="details-form-field">
            <button type="submit" id="save">Save</button>
        </div>
    </form>
</div>

<script src="/res/lib/jquery/3.7.1/jquery.min.js"></script>
<script src="/res/lib/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
<script src="/res/lib/jquery-ui/1.14.1/jquery-ui.min.js"></script>
<script src="/res/lib/jsgrid/1.5.3/jsgrid.min.js"></script>
<script src="/res/lib/jquery-validate/1.19.5/jquery.validate.min.js"></script>

<script>
	/**
	// MyDateField is required to let date picker happen. http://js-grid.com/docs/#custom-field
	let MyDateField = function(config) {
		jsGrid.Field.call(this, config);
	};
	//let $j = jQuery.noConflict(); //https://stackoverflow.com/questions/1212696/jquery-ui-datepicker-datepicker-is-not-a-function
	MyDateField.prototype = new jsGrid.Field({
		
		css: "date-field",            // redefine general property 'css'
		align: "center",              // redefine general property 'align'
		
		myCustomProperty: "foo",      // custom property
		
		sorter: function(date1, date2) {
			return new Date(date1) - new Date(date2);
		},
		
		itemTemplate: function(value) {
			return new Date(value).toDateString();
		},
		
		insertTemplate: function(value) {
			return this._insertPicker = $('<input type="date">').datepicker({ defaultDate: new Date() });
		},
		
		editTemplate: function(value) {
			return this._editPicker = $('<input type="date">').datepicker().datepicker("setDate", new Date(value));
		},
		
		insertValue: function() {
			return this._insertPicker.datepicker("getDate").toISOString();
		},
		
		editValue: function() {
			return this._editPicker.datepicker("getDate").toISOString();
		}
	});
	
	jsGrid.fields.date = MyDateField;
	*/	

	var MyDateField = function(config) {
        jsGrid.Field.call(this, config);
    };

    MyDateField.prototype = new jsGrid.Field({
        sorter: function(date1, date2) {
            return new Date(date1) - new Date(date2);
        },

        itemTemplate: function(value) {
			let date = new Date(value);
			let year = new Intl.DateTimeFormat('en', { year: 'numeric' }).format(date);
			let month = new Intl.DateTimeFormat('en', { month: '2-digit' }).format(date);
			let day = new Intl.DateTimeFormat('en', { day: '2-digit' }).format(date);

            return year + "-" + month + "-" + day;
        },

        insertTemplate: function() {
            alert("insertTemplate");
            return this._insertPicker = $("<input>").datepicker({
                format: 'YYYY-MM-DD'
            });
//            }).datepicker("setDate", new Date(value));
        },

        editTemplate: function(value) {
            alert("editTemplate[value]: " + value);
            //            return this._editPicker = $("<input>").datepicker().datepicker("setDate", new Date(value));

            return this._editPicker = $("<input>").datepicker({
                format: 'YYYY-MM-DD'
            }).datepicker("setDate", new Date(value));
        },

        insertValue: function() {
			let date = this._insertPicker.datepicker("getDate");
			let year = new Intl.DateTimeFormat('en', { year: 'numeric' }).format(date);
			let month = new Intl.DateTimeFormat('en', { month: '2-digit' }).format(date);
			let day = new Intl.DateTimeFormat('en', { day: '2-digit' }).format(date);

            alert("insertValue: " + year + "-" + month + "-" + day);
            return year + "-" + month + "-" + day;
        },

        editValue: function() {
			let date = this._editPicker.datepicker("getDate");
			let year = new Intl.DateTimeFormat('en', { year: 'numeric' }).format(date);
			let month = new Intl.DateTimeFormat('en', { month: '2-digit' }).format(date);
			let day = new Intl.DateTimeFormat('en', { day: '2-digit' }).format(date);

            alert("editValue: " + year + "-" + month + "-" + day);
            return year + "-" + month + "-" + day;
        }
    });

    jsGrid.fields.myDateField = MyDateField;

	$("#messagesGrid").jsGrid({
		height: "auto",
		width: "100%",
		editing: true,
		autoload: true,
		paging: true,
		filtering: false,
		sorting: true,
		deleteConfirm: function(item) {
            return "The message \"" + item.subject + "\" will be removed. Are you sure?";
        },
        rowClick: function(args) {
            showDetailsDialog("Edit", args.item);
        },
		controller: {
			loadData: function () {
				let d = $.Deferred();
				
				$.ajax({
					type: "GET",
					url: "/api/landpage/message",
					dataType: "json"
				}).done(function (response) {
					d.resolve(response);
				});
				
				return d.promise();
			},
			
			insertItem: function (message) {
				alert(JSON.stringify(message));
				return $.ajax({
					type: "POST",
					url: "/api/landpage/message",
					dataType: "json",
					contentType: "application/json; charset=UTF-8",
					data: JSON.stringify(message)
				});
			},
			
			updateItem: function (message) {
				alert(JSON.stringify(message));
				return $.ajax({
					type: "PUT",
					url: "/api/landpage/message/" + message.id,
					dataType: "json",
					contentType: "application/json; charset=UTF-8",
					data: JSON.stringify(message)
				});
			},
			
			deleteItem: function (message) {
				return $.ajax({
					type: "DELETE",
					url: "/api/landpage/message/" + message.id
				});
			}
		},
		
		fields: [
			{
				name: "subject",
				title: "Subject",
				width: 150,
				type: "text",
				validate: "required"
			},
			{
				name: "priority",
				title: "Priority",
				width: 50,
				validate: "required",
				"defaultValue": 1,
				validate: [
					{ validator: "required" },
					{ validator: "range", param: [1, 5] }
				]
},
			{
				name: "startDate",
				title: "Start Date",
				width: 75,
				type: "myDateField"
			},
			{
				name: "endDate",
				title: "End Date",
				width: 75,
				type: "myDateField"
			},
			{
				name: "content",
				title: "Content",
				type: "textarea"
			},
            {
                type: "control",
                modeSwitchButton: false,
                editButton: false,
                headerTemplate: function() {
                    return $("<button>").attr("type", "button").text("Add")
                            .on("click", function () {
                                showDetailsDialog("Add", {});
                            });
                }
            }
		]
	});	

    $("#detailsDialog").dialog({
        autoOpen: false,
        width: 600,
        close: function() {
            $("#detailsForm").validate().resetForm();
            $("#detailsForm").find(".error").removeClass("error");
        }
    });

	$("#detailsForm").validate({
        rules: {
            subject: "required",
            priority: { required: true, range: [1, 5] },
            startDate: "required",
            endDate: "required",
			msgcontent: "required"
        },
        messages: {
            subject: "Please enter message subject",
            priority: "Please select a priority",
            startDate: "Please enter a start date",
            endDate: "Please enter an end date",
            msgcontent: "Please enter message content",
        },
        submitHandler: function() {
            formSubmitHandler();
        }
    });
 
    var formSubmitHandler = $.noop;
 
    var showDetailsDialog = function(dialogType, message) {
        $("#subject").val(message.subject);
        $("#priority").val(message.priority);
        $("#startDate").val(message.startDate);
        $("#endDate").val(message.endDate);
        $("#msgcontent").val(message.content);
 
        formSubmitHandler = function() {
            saveMessage(message, dialogType === "Add");
        };

        $("#detailsDialog").dialog("option", "title", dialogType + " Message")
                .dialog("open");
   };
 
    var saveMessage = function(message, isNew) {
        $.extend(message, {
            subject: $("#subject").val(),
            priority: $("#priority").val(),
            startDate: $("#startDate").val(),
            endDate: $("#endDate").val(),
            content: $("#msgcontent").val()
        });
 
        $("#messagesGrid").jsGrid(isNew ? "insertItem" : "updateItem", message);
 
        $("#detailsDialog").dialog("close");
    };
</script>

</body>
</html>
-->