<!DOCTYPE html>
<html lang="en_us">
<head>
	<meta charset="UTF-8">
	<title>Landing Page - Editor</title>
	<link rel="stylesheet" href="/res/lib/bootstrap/5.3.3/css/bootstrap.min.css">
	<link rel="stylesheet" href="/res/lib/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css">
	<link rel="stylesheet" href="/res/lib/jsgrid/1.5.3/jsgrid.min.css">
	<link rel="stylesheet" href="/res/lib/jsgrid/1.5.3/jsgrid-theme.min.css">
	<link rel="stylesheet" href="/res/lib/jquery-ui/1.14.1/jquery-ui.theme.min.css">
	<link rel="stylesheet" href="/res/css/main.css">
	<style>
    .ui-widget *, .ui-widget input, .ui-widget select, .ui-widget button  {
        font-family: 'Helvetica Neue Light', 'Open Sans', Helvetica;
        font-size: 14px;
        font-weight: 300 !important;
    }

    .details-form-field input,
    .details-form-field select {
        width: 250px;
        float: right;
    }

    .details-form-field {
        margin: 30px 0;
    }

    .details-form-field:first-child {
        margin-top: 10px;
    }

    .details-form-field:last-child {
        margin-bottom: 10px;
    }

    .details-form-field button {
        display: block;
        width: 100px;
        margin: 0 auto;
    }

    input.error, select.error {
        border: 1px solid #ff9999;
        background: #ffeeee;
    }

    label.error {
        float: right;
        margin-left: 100px;
        font-size: .8em;
        color: #ff6666;
    }

    .hasDatepicker {
        width: 100px;
        text-align: center;
    }

    .ui-datepicker * {
        font-family: 'Helvetica Neue Light', 'Open Sans', Helvetica;
        font-size: 14px;
        font-weight: 300 !important;
    }
	</style>
</head>
<body class="min-vh-100 vstack">
<div class="container-fluid min-vh-100 d-flex flex-column">
	<main id="content">
		<div class="row">
			<div class="col-6 justify-content-start">
				<h1 class="text-light align-middle">Landing Page - Editor</h1>
			</div>
			<div class="col-6 text-end">
				<a href="/" class="btn btn-primary btn-sm">Close</a>
			</div>
		</div>
		
		<div class="row">
			<div class="col">
				<div id="messagesGrid"></div>
			</div>
		</div>
	</main>
</div>

<div id="detailsDialog">
    <form id="detailsForm">
        <div class="details-form-field">
            <label for="subject">Subject:</label>
            <input id="subject" name="subject" type="text" />
        </div>
        <div class="details-form-field">
            <label for="priority">Priority:</label>
            <select id="priority" name="priority">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
            </select>
        </div>
        <div class="details-form-field">
            <label for="startDate">Start Date:</label>
            <input id="startDate" name="startDate" type="date" />
        </div>
        <div class="details-form-field">
            <label for="endDate">End Date:</label>
            <input id="endDate" name="endDate" type="date" />
        </div>
        <div class="details-form-field">
            <label for="msgcontent">Content:</label>
            <input id="msgcontent" name="msgcontent" type="text" />
        </div>
        <div class="details-form-field">
            <button type="submit" id="save">Save</button>
        </div>
    </form>
</div>

<script src="/res/lib/jquery/3.7.1/jquery.min.js"></script>
<script src="/res/lib/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
<script src="/res/lib/jquery-ui/1.14.1/jquery-ui.min.js"></script>
<script src="/res/lib/jsgrid/1.5.3/jsgrid.min.js"></script>
<script src="/res/lib/jquery-validate/1.19.5/jquery.validate.min.js"></script>

<script>
	/**
	// MyDateField is required to let date picker happen. http://js-grid.com/docs/#custom-field
	let MyDateField = function(config) {
		jsGrid.Field.call(this, config);
	};
	//let $j = jQuery.noConflict(); //https://stackoverflow.com/questions/1212696/jquery-ui-datepicker-datepicker-is-not-a-function
	MyDateField.prototype = new jsGrid.Field({
		
		css: "date-field",            // redefine general property 'css'
		align: "center",              // redefine general property 'align'
		
		myCustomProperty: "foo",      // custom property
		
		sorter: function(date1, date2) {
			return new Date(date1) - new Date(date2);
		},
		
		itemTemplate: function(value) {
			return new Date(value).toDateString();
		},
		
		insertTemplate: function(value) {
			return this._insertPicker = $('<input type="date">').datepicker({ defaultDate: new Date() });
		},
		
		editTemplate: function(value) {
			return this._editPicker = $('<input type="date">').datepicker().datepicker("setDate", new Date(value));
		},
		
		insertValue: function() {
			return this._insertPicker.datepicker("getDate").toISOString();
		},
		
		editValue: function() {
			return this._editPicker.datepicker("getDate").toISOString();
		}
	});
	
	jsGrid.fields.date = MyDateField;
	*/	

	var MyDateField = function(config) {
        jsGrid.Field.call(this, config);
    };

    MyDateField.prototype = new jsGrid.Field({
        sorter: function(date1, date2) {
            return new Date(date1) - new Date(date2);
        },

        itemTemplate: function(value) {
			let date = new Date(value);
			let year = new Intl.DateTimeFormat('en', { year: 'numeric' }).format(date);
			let month = new Intl.DateTimeFormat('en', { month: '2-digit' }).format(date);
			let day = new Intl.DateTimeFormat('en', { day: '2-digit' }).format(date);

            return year + "-" + month + "-" + day;
        },

        insertTemplate: function(value) {
			let date = new Date(value);
            return this._insertPicker = $("<input>").datepicker().datepicker("setDate", new Date(value));
        },

        editTemplate: function(value) {
            return this._editPicker = $("<input>").datepicker().datepicker("setDate", new Date(value));
        },

        insertValue: function() {
			let date = this._insertPicker.datepicker("getDate");
			let year = new Intl.DateTimeFormat('en', { year: 'numeric' }).format(date);
			let month = new Intl.DateTimeFormat('en', { month: '2-digit' }).format(date);
			let day = new Intl.DateTimeFormat('en', { day: '2-digit' }).format(date);

            return year + "-" + month + "-" + day;
        },

        editValue: function() {
			let date = this._editPicker.datepicker("getDate");
			let year = new Intl.DateTimeFormat('en', { year: 'numeric' }).format(date);
			let month = new Intl.DateTimeFormat('en', { month: '2-digit' }).format(date);
			let day = new Intl.DateTimeFormat('en', { day: '2-digit' }).format(date);

            return year + "-" + month + "-" + day;
        }
    });

    jsGrid.fields.myDateField = MyDateField;

	$("#messagesGrid").jsGrid({
		height: "auto",
		width: "100%",
		editing: true,
		autoload: true,
		paging: true,
		filtering: false,
		sorting: true,
		deleteConfirm: function(item) {
            return "The message \"" + item.subject + "\" will be removed. Are you sure?";
        },
        rowClick: function(args) {
            showDetailsDialog("Edit", args.item);
        },
		controller: {
			loadData: function () {
				let d = $.Deferred();
				
				$.ajax({
					type: "GET",
					url: "/api/landpage/message",
					dataType: "json"
				}).done(function (response) {
					d.resolve(response);
				});
				
				return d.promise();
			},
			
			insertItem: function (message) {
				alert(JSON.stringify(message));
				return $.ajax({
					type: "POST",
					url: "/api/landpage/message",
					dataType: "json",
					contentType: "application/json; charset=UTF-8",
					data: JSON.stringify(message)
				});
			},
			
			updateItem: function (message) {
				alert(JSON.stringify(message));
				return $.ajax({
					type: "PUT",
					url: "/api/landpage/message/" + message.id,
					dataType: "json",
					contentType: "application/json; charset=UTF-8",
					data: JSON.stringify(message)
				});
			},
			
			deleteItem: function (message) {
				return $.ajax({
					type: "DELETE",
					url: "/api/landpage/message/" + message.id
				});
			}
		},
		
		fields: [
			{
				name: "subject",
				title: "Subject",
				width: 150,
				type: "text",
				validate: "required"
			},
			{
				name: "priority",
				title: "Priority",
				width: 50,
				validate: "required",
				"defaultValue": 1,
				validate: [
					{ validator: "required" },
					{ validator: "range", param: [1, 5] }
				]
},
			{
				name: "startDate",
				title: "Start Date",
				width: 75,
				type: "myDateField"
			},
			{
				name: "endDate",
				title: "End Date",
				width: 75,
				type: "myDateField"
			},
			{
				name: "content",
				title: "Content",
				type: "textarea"
			},
            {
                type: "control",
                modeSwitchButton: false,
                editButton: false,
                headerTemplate: function() {
                    return $("<button>").attr("type", "button").text("Add")
                            .on("click", function () {
                                showDetailsDialog("Add", {});
                            });
                }
            }
		]
	});	

    $("#detailsDialog").dialog({
        autoOpen: false,
        width: 600,
        close: function() {
            $("#detailsForm").validate().resetForm();
            $("#detailsForm").find(".error").removeClass("error");
        }
    });

	$("#detailsForm").validate({
        rules: {
            subject: "required",
            priority: { required: true, range: [1, 5] },
            startDate: "required",
            endDate: "required",
			msgcontent: "required"
        },
        messages: {
            subject: "Please enter message subject",
            priority: "Please select a priority",
            startDate: "Please enter a start date",
            endDate: "Please enter an end date",
            msgcontent: "Please enter message content",
        },
        submitHandler: function() {
            formSubmitHandler();
        }
    });
 
    var formSubmitHandler = $.noop;
 
    var showDetailsDialog = function(dialogType, message) {
        $("#subject").val(message.subject);
        $("#priority").val(message.priority);
        $("#startDate").val(message.startDate);
        $("#endDate").val(message.endDate);
        $("#msgcontent").val(message.content);
 
        formSubmitHandler = function() {
            saveMessage(message, dialogType === "Add");
        };

        $("#detailsDialog").dialog("option", "title", dialogType + " Message")
                .dialog("open");
   };
 
    var saveMessage = function(message, isNew) {
        $.extend(message, {
            subject: $("#subject").val(),
            priority: $("#priority").val(),
            startDate: $("#startDate").val(),
            endDate: $("#endDate").val(),
            content: $("#msgcontent").val()
        });
 
        $("#messagesGrid").jsGrid(isNew ? "insertItem" : "updateItem", message);
 
        $("#detailsDialog").dialog("close");
    };
</script>

</body>
</html>
